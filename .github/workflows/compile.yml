name: "Compile with MSBuild for Windows"

on:
  workflow_dispatch:
  push:
    branches: [ "VS_2022_x64_release_config_only" ]
  # pull_request:
  #   branches: [ "main" ]

env:
  # Path to the solution file relative to the root of the project.
  SOLUTION_FILE_PATH: sDNA\sdna_vs2008\sdna_vs2008.sln
  BUILD_CONFIGURATION: Release

jobs:
  compile:
    name: Try to compile on windows
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4




    - name: 'Add "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\bin" to path'
      shell: bash
      run: echo "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\bin" >> $GITHUB_PATH

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.1

    - name: Integrate vcpkg with Visual Studio
      run: vcpkg integrate install


    - name: Restore Cached Deps
      id: cache-deps-restore
      uses: actions/cache/restore@v3
      with:
        path: |
          D:\a\sdna_plus\sdna_plus\vcpkg_installed\
          
        key: ${{ runner.os }}-${{ hashFiles('vcpkg.json') }}


    - name: Install Geos and Boost from vcpkg.json
      run: vcpkg install

 
    - name: Cache Deps
      id: cache-deps-save
      uses: actions/cache/save@v3
      with:
        path: |
          D:\a\sdna_plus\sdna_plus\vcpkg_installed\
          
        key: ${{ steps.cache-deps-restore.outputs.cache-primary-key }}

    - name: Build sDNA
      working-directory: ${{env.GITHUB_WORKSPACE}}
      # run: msbuild /m /p:Platform=x64 /p:Configuration=${{env.BUILD_CONFIGURATION}} /p:VcpkgEnableManifest=true ${{env.SOLUTION_FILE_PATH}}
      run: msbuild build_installer.proj /t:rebuild /p:Configuration=release /p:Platform=x64  /p:VcpkgEnableManifest=true

    - name: upload output dir
      uses: actions/upload-artifact@v3
      with:
        name: sdna_plus_output
        path: output/release


